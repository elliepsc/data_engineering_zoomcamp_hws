# Docker Compose for Module 4 - Analytics Engineering

services:
  dbt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dbt-analytics-engineering
    volumes:
      # Mount entire project directory
      - ./:/workspace
      
      # Mount dbt profiles from local ~/.dbt/ (PRO/TEAM approach)
      # :ro = read-only for security (prevents accidental modification of credentials)
      # WHY: Keeps credentials separate from code repository (never committed to Git)
      # dbt will use profiles.yml from ~/.dbt/ on your host machine
      - ~/.dbt:/root/.dbt:ro
      
    working_dir: /workspace/taxi_rides_ny
    environment:
      # Use standard dbt location for PRO/TEAM setup
      # This keeps credentials (local) separate from code (Git repository)
      DBT_PROFILES_DIR: /root/.dbt
      
      # Optional: BigQuery credentials (for production deployment)
      # GOOGLE_APPLICATION_CREDENTIALS: /workspace/credentials/gcp-key.json
      
    ports:
      # dbt docs serve on port 38080 (changed from default 8080)
      # WHY: Avoid port conflicts in data engineering stack:
      #   - Airflow    → 8080
      #   - Kestra     → 18080
      #   - pgAdmin    → 28080
      #   - dbt docs   → 38080  ← we are here
      #   - Superset   → 48080 (future)
      - "38080:8080"
      
    command: /bin/bash
    stdin_open: true
    tty: true
    networks:
      - dbt-network

networks:
  dbt-network:
    driver: bridge

# ============================================
# USAGE INSTRUCTIONS
# ============================================
# 
# First-time setup:
#   1. mkdir -p ~/.dbt
#   2. cp profiles.yml.example ~/.dbt/profiles.yml
#   3. Edit ~/.dbt/profiles.yml with your configuration
#
# Build and run:
#   make build    # or: docker-compose build
#   make up       # or: docker-compose up -d
#
# Development:
#   make shell    # or: docker-compose exec dbt bash
#   make dbt-run  # or: docker-compose exec dbt dbt run
#
# Stop:
#   make down     # or: docker-compose down
#
# View dbt docs:
#   make dbt-docs # or: docker-compose exec dbt dbt docs serve
#   Open: http://localhost:38080